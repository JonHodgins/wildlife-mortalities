@using WildlifeMortalities.App.Extensions
@using WildlifeMortalities.App.Features.Shared.Mortalities
@using WildlifeMortalities.Data.Entities.BiologicalSubmissions
@using WildlifeMortalities.Data.Entities.BiologicalSubmissions.Shared;
@using WildlifeMortalities.Data.Enums
@using WildlifeMortalities.Shared.Extensions;
@using WildlifeMortalities.Shared.Services
<MudCard Elevation="3" Class="flex-column d-flex" Style="height: 100%">
    <MudCardHeader>
        <CardHeaderContent>
            @{
                var mortalityName = MortalityViewModel.Species?.GetDisplayName();
            }
            @if (MortalityViewModel.IsDraft)
            {
                <MudText Typo="Typo.h6" Color="Color.Warning">Draft: @mortalityName </MudText>
            }
            else
            {
                <MudText Typo="Typo.h6">@mortalityName</MudText>
            }
        </CardHeaderContent>
        <CardHeaderActions>
            @if (EnableBioSubmission && MortalityViewModel.GetMortality() is IHasBioSubmission biosubmission)
            {
                if(MortalityViewModel.BioSubmission!.Status == BioSubmissionStatus.Submitted)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="OpenBioSubmissionAnalysisDialog" StartIcon="@Icons.Material.Filled.Science">Bio submission</MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="OpenOrganicMaterialForBioSubmissionDialog" StartIcon="@Icons.Material.Filled.Science">Bio submission</MudButton>
                }
            }
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent Class="flex-column d-flex" Style="height: 100%">
        <MudStack Row="false">
            @foreach (var property in MortalityViewModel.GetProperties())
            {
                var normalizedValue = (property.Value ?? string.Empty).ToLower();
                @if (bool.TryParse(property.Value, out var value))
                {
                    <MudCheckBox T="bool" ReadOnly="true" Checked="value" Label="@property.Key"/>
                }
                else if (DateTime.TryParse(property.Value, out var dateValue))
                {
                    <MudField DisableUnderLine="true" Label="@property.Key">@dateValue.Date.ToShortDateString()</MudField>
                }
                else
                {
                    <MudField DisableUnderLine="true" Label="@property.Key">@property.Value</MudField>
                }
            }
            <MudField DisableUnderLine="true" Label="Comment">@ActivityViewModel.Comment</MudField>
            @switch (ActivityViewModel)
            {
                case HuntedActivityViewModel vm:
                    <MudField DisableUnderLine="true" Label="Landmark">@vm.Landmark</MudField>
                    <MudField DisableUnderLine="true" Label="Game management area">@vm.GameManagementArea.Area</MudField>
                    break;
                case TrappedActivityViewModel vm:
                    break;
            }
        </MudStack>
        <MudSpacer/>
        @if (MortalityViewModel.GetMortality() is IHasBioSubmission)
        {
            <BioSubmissionDetailsComponent BioSubmission="@MortalityViewModel.BioSubmission"/>
        }
    </MudCardContent>
    <MudCardActions>
        <MudStack Row="true" Class="justify-right">
            <MudSpacer/>
            @if (EnableEdit)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="OnEditClicked" Color="Color.Primary"/>
            }
            @if (EnableDelete)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="OnDeleteClicked" Color="Color.Error"/>
            }
        </MudStack>
    </MudCardActions>
</MudCard>

@code {

    [Parameter]
    public ActivityViewModel ActivityViewModel { get; set; } = null!;

    public MortalityViewModel MortalityViewModel => ActivityViewModel.MortalityWithSpeciesSelectionViewModel.MortalityViewModel;

    [Parameter]
    public bool EnableBioSubmission { get; set; } = true;

    [Parameter]
    public bool EnableEdit { get; set; } = false;

    [Parameter]
    public bool EnableDelete { get; set; } = false;

    [Parameter]
    public EventCallback OnEditClicked { get; set; }

    [Parameter]
    public EventCallback OnDeleteClicked { get; set; }

    [Inject]
    IDialogService DialogService { get; set; } = null!;

    [Inject]
    IMortalityService Service { get; set; } = null!;


    private async Task OpenBioSubmissionAnalysisDialog()
    {
        var bioSubmission = MortalityViewModel.BioSubmission!;

        var parameters = new DialogParameters();
        parameters.Add(nameof(BioSubmissionAnalysisDialog.BioSubmission), bioSubmission);

        var dialog = await DialogService.ShowAsync<BioSubmissionAnalysisDialog>("", parameters);
        var result = await dialog.Result;

        if (result.Canceled == false)
        {
            await Service.UpdateBioSubmissionAnalysis(bioSubmission);
        }
    }
    

    private async Task OpenOrganicMaterialForBioSubmissionDialog()
    {
        var bioSubmission = MortalityViewModel.BioSubmission!;

        var parameters = new DialogParameters();
        parameters.Add(nameof(OrganicMaterialForBioSubmissionDialog.BioSubmission), bioSubmission);

        var dialog = await DialogService.ShowAsync<OrganicMaterialForBioSubmissionDialog>("", parameters);
        var result = await dialog.Result;

        if (result.Canceled == false)
        {
            await Service.UpdateOrganicMaterialForBioSubmission(bioSubmission);
        }
    }

}
