@using WildlifeMortalities.App.Extensions
@using WildlifeMortalities.App.Features.Shared.Mortalities
@using WildlifeMortalities.Data.Entities.BiologicalSubmissions
@using WildlifeMortalities.Data.Entities.BiologicalSubmissions.Shared;
@using WildlifeMortalities.Data.Enums
@using WildlifeMortalities.Shared.Extensions;
@using WildlifeMortalities.Shared.Services
<MudCard Elevation="3" Class="flex-column d-flex" Style="height: 100%; min-width: 250px; width: 350px;">
    <MudCardHeader>
        <CardHeaderContent>
            @{
                var mortalityName = MortalityViewModel.Species?.GetDisplayName();
            }
            @if (MortalityViewModel.IsDraft)
            {
                <MudText Typo="Typo.h6" Color="Color.Warning">Draft: @mortalityName </MudText>
            }
            else
            {
                <MudText Typo="Typo.h6">@mortalityName</MudText>
            }
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent Class="flex-column d-flex" Style="height: 100%">
        <MudStack Row="false">
            @foreach (var property in MortalityViewModel.GetProperties())
            {
                var normalizedValue = (property.Value ?? string.Empty).ToLower();
                @if (bool.TryParse(property.Value, out var value))
                {
                    <MudCheckBox T="bool" ReadOnly="true" Checked="value" Label="@property.Key"/>
                }
                else if (DateTime.TryParse(property.Value, out var dateValue))
                {
                    <MudField DisableUnderLine="true" Label="@property.Key">@dateValue.Date.ToShortDateString()</MudField>
                }
                else
                {
                    <MudField DisableUnderLine="true" Label="@property.Key">@property.Value</MudField>
                }
            }
            @switch (ActivityViewModel)
            {
                case HuntedActivityViewModel vm:
                    @if (!string.IsNullOrWhiteSpace(vm.Landmark))
                    {
                        <MudField DisableUnderLine="true" Label="Landmark">@vm.Landmark</MudField>
                    }
                    <MudField DisableUnderLine="true" Label="Game management area">@vm.GameManagementArea?.Area</MudField>
                    break;
                case TrappedActivityViewModel vm:
                    break;
            }
            @if (!string.IsNullOrWhiteSpace(ActivityViewModel.Comment))
            {
                <MudField DisableUnderLine="true" Label="Comment">@ActivityViewModel.Comment</MudField>
            }
        </MudStack>
        <MudSpacer/>
        @if (MortalityViewModel.GetMortality() is IHasBioSubmission)
        {
            <BioSubmissionDetailsComponent BioSubmission="@MortalityViewModel.BioSubmission"/>
        }
    </MudCardContent>
    <MudCardActions>
        <MudStack Row="true" Class="justify-right">
            <MudSpacer/>
            @if (EnableEdit)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="OnEditClicked" Color="Color.Primary"/>
            }
            @if (EnableDelete)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="OnDeleteClicked" Color="Color.Error"/>
            }
        </MudStack>
    </MudCardActions>
</MudCard>

@code {

    [Parameter]
    public EventCallback ChangeSpeciesClicked { get; set; }

    [Parameter]
    public ActivityViewModel ActivityViewModel { get; set; } = null!;

    public MortalityViewModel MortalityViewModel => ActivityViewModel.MortalityWithSpeciesSelectionViewModel.MortalityViewModel;

    [Parameter]
    public bool EnableBioSubmission { get; set; } = true;

    [Parameter]
    public bool EnableEdit { get; set; } = false;

    [Parameter]
    public bool EnableDelete { get; set; } = false;

    [Parameter]
    public EventCallback OnEditClicked { get; set; }

    [Parameter]
    public EventCallback OnDeleteClicked { get; set; }
}
